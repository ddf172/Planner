name: Generate Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'server/workspace/src/**'
      - 'server/workspace/include/**'
      - 'server/workspace/Doxyfile'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'server/workspace/src/**'
      - 'server/workspace/include/**'
      - 'server/workspace/Doxyfile'

jobs:
  docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Doxygen
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
        
    - name: Clear existing documentation
      run: |
        echo "🗑️ Clearing existing docs directory..."
        rm -rf docs/*
        echo "✅ docs directory cleared"
        
    - name: Generate Doxygen documentation
      run: |
        echo "📚 Generating Doxygen documentation..."
        cd server/workspace
        doxygen Doxyfile
        echo "✅ Documentation generated"
        
    - name: Verify documentation was generated
      run: |
        echo "🔍 Verifying documentation..."
        if [ -d "docs" ] && [ "$(ls -A docs)" ]; then
          echo "✅ Documentation directory exists and is not empty"
        else
          echo "❌ Documentation directory is empty or missing"
          exit 1
        fi
        
    - name: Commit and push documentation
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes to commit
        if git diff --quiet && git diff --staged --quiet; then
          echo "📝 No changes to documentation detected"
        else
          echo "📝 Committing documentation updates..."
          git add docs/
          git commit -m "📚 Auto-update documentation via GitHub Actions
          
          - Generated from latest source code
          - Cleared previous docs and regenerated
          - Triggered by: ${{ github.event_name }} on ${{ github.ref_name }}"
          
          echo "🚀 Pushing changes..."
          git push
          echo "✅ Documentation updated and pushed"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
